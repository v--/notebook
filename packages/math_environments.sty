\ExplSyntaxOn

% Multi-page align environments
% Based on https://tex.stackexchange.com/a/162895
\NewDocumentEnvironment {balign*} {}
  {
    \begingroup
    \allowdisplaybreaks
    \start@align\@ne\st@rredtrue\m@ne
  }
  {
    \endalign
    \endgroup
  }

\NewDocumentEnvironment {balign} {}
  {
    \begingroup
    \allowdisplaybreaks
    \align
  }
  {
    \endalign
    \endgroup
  }

% Annotations for the backnaur package
\NewDocumentEnvironment {longbnf*} {}
  {
    \RenewDocumentCommand \arraystretch {} {1.2}
    \begin{longtable}{R L L}
  }
  {
    \end{longtable}
  }

\NewDocumentEnvironment {bnfextra*} {}
  {
    \begin{center}
    \RenewDocumentCommand \arraystretch {} {1.2}
    \begin{tabular}{R L L L}
  }
  {
    \end{tabular}
    \end{center}
  }


\NewDocumentCommand \bnfe {m} {& \text{#1}}

% Memory lines
\NewDocumentCommand \MemoryLineArrow {O{}m}
  {
    \smash
      {
        \underset
          {
            {\substack{{} \\ \uparrow \\ {#1}}}
          }
          {#2}
      }
  }

\tl_new:N \l_nb_memory_line_array_param
\NewDocumentEnvironment {MemoryLine} {mo}
  {
    \IfValueTF {#2}
      {
        \tl_set:Nn \l_nb_memory_line_array_param
          {
            *{\int_eval:n {#2 - 1}} {| c}
            {!{\vline width 1.5pt} c !{\vline width 1.5pt}}
            *{\int_eval:n {#1 - #2}} {c |}
          }
      }
      {
        \tl_set:Nn \l_nb_memory_line_array_param
          {
            | *{#1} {c |}
          }
      }

    \begin{equation*}
    \exp_args:Nne \begin {array} {\l_nb_memory_line_array_param}
    \hline
  }
  {
    \\ \hline
    \end{array}
    \end{equation*}
  }

\ExplSyntaxOff
