% Multi-page align environments
% Based on https://tex.stackexchange.com/a/162895
\NewDocumentEnvironment {balign*} {}
  {
    \begingroup
    \allowdisplaybreaks
    \start@align\@ne\st@rredtrue\m@ne
  }
  {
    \endalign
    \endgroup
  }

\NewDocumentEnvironment {balign} {}
  {
    \begingroup
    \allowdisplaybreaks
    \align
  }
  {
    \endalign
    \endgroup
  }

% Annotations for the backnaur package
\NewDocumentEnvironment {bnfextra} {}
  {
    \leavevmode\newline
    \center
    \begingroup
    \RenewDocumentCommand \arraystretch {} {1.2}
    \tabular{R L L L}
  }
  {
    \endtabular
    \endgroup
    \endcenter
    \leavevmode
  }


\NewDocumentCommand \bnfe {m} {& \text{#1}}

% Memory lines
\NewDocumentCommand \MemoryLineArrow {O{}m}
  {
    \smash
      {
        \underset
          {
            {\substack{{} \\ \uparrow \\ {#1}}}
          }
          {#2}
      }
  }

\NewDocumentEnvironment {MemoryLine} {m}
  {
    \begin{equation*}
    \begin{array}{| *{#1} {c |}}
    \hline
  }
  {
    \\ \hline
    \end{array}
    \end{equation*}
  }
