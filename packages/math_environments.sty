\ExplSyntaxOn

% Multi-page align environments
% Based on https://tex.stackexchange.com/a/162895
\NewDocumentEnvironment {balign*} {}
  {
    \begingroup
    \allowdisplaybreaks
    \start@align\@ne\st@rredtrue\m@ne
  }
  {
    \endalign
    \endgroup
  }

\NewDocumentEnvironment {balign} {}
  {
    \begingroup
    \allowdisplaybreaks
    \align
  }
  {
    \endalign
    \endgroup
  }

% Centered verbatim
\NewDocumentEnvironment {CVerbatim} {}
  {
    \VerbatimEnvironment
    \begin{center}
    \begin{BVerbatim}
  }
  {
    \end{BVerbatim}
    \end{center}
  }

% Annotations for the backnaur package
\NewDocumentEnvironment {longbnf*} {}
  {
    \RenewDocumentCommand \arraystretch {} {1.2}
    \begin{longtable}{R L L}
  }
  {
    \end{longtable}
  }

\NewDocumentEnvironment {bnfextra*} {}
  {
    \begin{center}
    \RenewDocumentCommand \arraystretch {} {1.2}
    \begin{tabular}{R L L L}
  }
  {
    \end{tabular}
    \end{center}
  }


\NewDocumentCommand \bnfe {m} {& \text{#1}}

% Memory lines
\NewDocumentEnvironment {MemoryLine} {}
  {
    % Placeholder
    \NewDocumentCommand \MP {} {\ensuremath{\anon}\space}

    % Highlight
    \NewDocumentCommand \MH {m} {\hi{##1}}

    \begin{center}
    \ttfamily
  }
  {
    \rmfamily
    \end{center}
  }

\ExplSyntaxOff
