% Multi-page align environments
% Based on https://tex.stackexchange.com/a/162895
\NewDocumentEnvironment {balign*} {}
  {
    \begingroup
    \allowdisplaybreaks
    \start@align\@ne\st@rredtrue\m@ne
  }
  {
    \endalign
    \endgroup
  }

\NewDocumentEnvironment {balign} {}
  {
    \begingroup
    \allowdisplaybreaks
    \align
  }
  {
    \endalign
    \endgroup
  }

% Annotations for the backnaur package
\NewDocumentEnvironment {longbnf*} {}
  {
    \RenewDocumentCommand \arraystretch {} {1.2}
    \begin{longtable}{R L L}
  }
  {
    \end{longtable}
  }

\NewDocumentEnvironment {bnfextra*} {}
  {
    \begin{center}
    \RenewDocumentCommand \arraystretch {} {1.2}
    \begin{tabular}{R L L L}
  }
  {
    \end{tabular}
    \end{center}
  }


\NewDocumentCommand \bnfe {m} {& \text{#1}}

% Memory lines
\NewDocumentCommand \MemoryLineArrow {O{}m}
  {
    \smash
      {
        \underset
          {
            {\substack{{} \\ \uparrow \\ {#1}}}
          }
          {#2}
      }
  }

\NewDocumentEnvironment {MemoryLine} {m}
  {
    \begin{equation*}
    \begin{array}{| *{#1} {c |}}
    \toprule
  }
  {
    \\ \bottomrule
    \end{array}
    \end{equation*}
  }
