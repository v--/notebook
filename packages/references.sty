\ExplSyntaxOn

% Items
\NewDocumentCommand \thmitem {om}
  {
    \IfValueTF {#1}
      {
        \item[{\crtcrossreflabel{\logic{#2}}[#1]}]
      }
      {
        \item\label{#2}
      }
  }

% Deprecated
\newlist {refenum} {itemize} {2}
\NewDocumentCommand \refitem {om}
  {
    \IfValueTF {#1}
      {
        \item[{\hyperref[#1]{#2}}]
      }
      {
        \item[\ref{#2}]
      }
  }

\prop_new:N \l_nb_term_group_prop
\seq_new:N \l_nb_term_group_seq

\NewDocumentCommand \fnote {m}
  {
    \footnote
      {
        \scriptsize
        #1
      }
  }

\NewDocumentCommand \term {om}
  {
    \textit{#2}
    \IfValueT{#1}
      {
        \prop_set_from_keyval:Nn \l_nb_term_group_prop {#1}

        \prop_map_inline:Nn \l_nb_term_group_prop
          {
            \seq_put_right:Nn \l_nb_term_group_seq
              {
                ##1:~##2
              }
          }

        \fnote{ \seq_use:Nn \l_nb_term_group_seq { ,~ } }

        \prop_clear:N \l_nb_term_group_prop
        \seq_clear:N \l_nb_term_group_seq
      }
  }

\NewDocumentCommand \mnote {m}
  {
    \leavevmode@ifvmode
    \marginpar
      {
        \raggedleft
        \scriptsize
        % For some reason, the text is sometimes not black, e.g. has the color of a hyperlink
        \textcolor {black} {#1}
      }
    \ignorespaces
  }

\NewDocumentCommand \mimprovised {o}
  {
    \mnote
      {
        Author's \\ definition
      }
  }

\NewDocumentCommand \mcite {om}
  {
    \mnote
      {
        \IfValueTF {#1} { \cite[#1]{#2} } { \cite{#2} }
      }
  }

\NewDocumentCommand \tcite {mom}
  {
    \cs_set:Npn \__tcite_template:nn ##1 ##2 {#1}
    \__tcite_template:nn
      { \citeauthor{#3} }
      { \IfValueTF {#2} { \cite[#2]{#3} } { \cite{#3} } }
  }

\NewDocumentCommand \incite {som}
  {
    \IfBooleanTF {#1}
      { \tcite{In~##2,~##1}[#2]{#3} }
      { \tcite{##1~in~##2}[#2]{#3} }
  }

\NewDocumentCommand \bycite {om}
  {
    \tcite{##2~by~##1}[#1]{#2}
  }

\NewDocumentCommand \fullref {m}
  {
    \cref {#1}
    \ (\nameref*{#1})
  }

\NewDocumentCommand \Fullref {m}
  {
    \Cref {#1}
    \ (\nameref*{#1})
  }

\NewDocumentCommand \todo {m}
  {
    \textbf{TODO}:~#1
  }

% Based mostly on https://tex.stackexchange.com/a/160035
\NewDocumentCommand \taglabel {O{}m}
  {
    \phantomsection
    \protected@write \@auxout {}
      {
        \string \newlabel {#2} { {#1} {\thepage} {\@currentlabelname} {\@currentHref} {} }
      }
  }

\ExplSyntaxOff
