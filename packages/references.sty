\ExplSyntaxOn

% Items
\NewDocumentCommand \thmitem {om}
  {
    \IfValueTF {#1}
      {
        \item[{\crtcrossreflabel{#2}[#1]}]
      }
      {
        \item\label{#2}
      }
  }

\newlist {refenum} {itemize} {2}
\NewDocumentCommand \refitem {om}
  {
    \IfValueTF {#1}
      {
        \item[{\hyperref[#1]{#2}}]
      }
      {
        \item[\ref{#2}]
      }
  }

\seq_new:N \l_term_group_prop
\seq_new:N \l_term_group_seq

\NewDocumentCommand \term {om}
  {
    \textbf {#2}

    \IfValueT {#1}
    {
      \prop_set_from_keyval:Nn \l_term_group_prop {#1}

      \prop_map_inline:Nn \l_term_group_prop
      {
        \seq_push:Nn \l_term_group_seq
        {
          ##1:~##2
        }
      }

      % \prop_set_from_keyval:Nn seems to create the sequence in reverse
      \seq_reverse:N \l_term_group_seq

      \footnote
        {
          \group_begin:
            \fontencoding {T2A}
            \selectfont
            \seq_use:Nnnn \l_term_group_seq { ,~ } { ,~ } { ,~ }
          \group_end:
        }

      \prop_clear:N \l_term_group_prop
      \seq_clear:N \l_term_group_seq
    }
  }

% https://tex.stackexchange.com/a/427559
\prg_new_protected_conditional:Npnn \if_is_int:n #1 { T, F, TF }
  {
    \regex_match:nnTF { ^[\+\-]?[\d]+$ } {#1} % $
      { \prg_return_true: }
      { \prg_return_false: }
  }

% I have no idea why the colors sometimes get messed up or why the color hack below fixes it.
\NewDocumentCommand \mcite {om}
  {
    \leavevmode
    \marginpar
      {
        \raggedleft
        \footnotesize
        \textcolor { black } { \cite {#2} }
        \par
        \normalcolor
        \IfValueT {#1}
        {
          \if_is_int:nTF {#1} { page~#1 } {#1}
        }
      }
    \ignorespaces
  }

%
\tl_new:N \l_fullref_name_tl
\int_new:N \l_nameref_symbol_count
\regex_new:N \l_nameref_symbol_regex
\regex_set:Nn \l_nameref_symbol_regex { (,|/) }

\NewDocumentCommand \FullNameRef {m}
  {
    \regex_count:NnN \l_nameref_symbol_regex {#1} \l_nameref_symbol_count
    \int_compare:nNnT
      { \int_use:N \l_nameref_symbol_count } = { 0 }
      {
        \tl_set:Nx \l_fullref_name_tl { \crtrefname {#1} }
        \str_if_empty:NF \l_fullref_name_tl { \ (\tl_use:N \l_fullref_name_tl) }
      }
  }

\NewDocumentCommand \fullref {m}
  {
    \cref {#1}
    \FullNameRef {#1}
  }

\NewDocumentCommand \Fullref {m}
  {
    \Cref {#1}
    \FullNameRef {#1}
  }

\NewDocumentCommand \todo {m}
  {
    \textbf{TODO}:~#1
  }

% https://tex.stackexchange.com/a/550323
\NewDocumentCommand \taglabel {O{}m}
  {
    \phantomsection\def\@currentlabel{#1}\label{#2}
  }

\ExplSyntaxOff

