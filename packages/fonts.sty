\ExplSyntaxOn

%% In order to speed up compilation, I usually use pdflatex for development.
\bool_if:nTF
  { \sys_if_engine_xetex_p: || \sys_if_engine_luatex_p: }
  {
    \RequirePackage{fontspec}
    \RequirePackage
      [
        warnings-off={mathtools-colon,mathtools-overbracket}
      ]
      {unicode-math}

    \setmainfont{STIX~Two~Text}
    \setsansfont{Libertinus~Sans}
    \setmathfont{STIX~Two~Math}
  }
  {
    \RequirePackage[T2A,T1]{fontenc}
    \RequirePackage[not1,notextcomp]{stix2} % Serf and math font families; load after amsmath despite documentation, it breaks otherwise
    \RequirePackage[sans,tt=false,ScaleRM=1.075]{libertinus} % Sans-serif
    \DeclareFontFamilySubstitution{T2A}{stix2}{LibertinusSerif-TLF} % Fallback font that looks similar to STIX Two Text
    % Imitate some macros from unicode-math
    \DeclareMathOperator \Alpha   {A}
    \DeclareMathOperator \Beta    {B}
    \DeclareMathOperator \Eta     {H}
    \DeclareMathOperator \Tau     {T}
    \DeclareMathOperator \Iota    {I}
    \DeclareMathOperator \omicron {o}

    % https://tex.stackexchange.com/a/564222
    \NewDocumentCommand \DefineAlphabet {mmmm}
      {% #1 = prefix, #2 = command, #3 = start, #4 = end
        \int_step_inline:nnn { `#3 } { `#4 }
          {
            \cs_new_protected:cpx { #1 \char_generate:nn { ##1 }{ 11 } }
              {
                \exp_not:N #2 { \char_generate:nn { ##1 } { 11 } }
              }
          }
      }

    \let\Bbbk\relax

    \DefineAlphabet {Bbb}   \mathbb   {A} {Z}
    \DefineAlphabet {Bbb}   \mathbb   {a} {z}
    \DefineAlphabet {mscr}  \mathcal  {A} {Z}
    \DefineAlphabet {mscr}  \mathcal  {a} {z}
    \DefineAlphabet {mfrak} \mathfrak {A} {Z}
    \DefineAlphabet {mfrak} \mathfrak {a} {z}

    \let\DefineAlphabet\relax

    % stix2 doesn't behave well with text symbols, so I use math symbols instead
    \cs_if_exist:cT {setlist}
      {
        \setlist[itemize,1]{label=\( \bullet \)}
        \setlist[itemize,3]{label=\( \ast \)}
      }

    \cs_if_exist:cT {AtBeginBibliography}
      {
        \AtBeginBibliography
          {
            \fontencoding{T2A}
            \selectfont
          }
      }
  }
\ExplSyntaxOff

\RequirePackage{microtype}
